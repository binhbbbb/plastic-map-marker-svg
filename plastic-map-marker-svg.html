<!--
    @license MIT
-->

<link rel="import" href="../google-map/google-map-marker.html">

<!--
plastic-map-marker-svg

A superclass of `google-map-marker` with additional attributes to make
using SVG marker icons easier.


-->

<script>
    class PlasticMapMarkerSvg extends customElements.get('google-map-marker') {
        static get is() {
            return 'plastic-map-marker-svg';
        }
        // clone the google-map-marker template
        static get template() {
            if (!window.PlasticMapMarkerSvgTemplate) {
                window.PlasticMapMarkerSvgTemplate = customElements.get('google-map-marker').template.cloneNode(
                    true);
            }
            return window.PlasticMapMarkerSvgTemplate;
        }
        static get properties() {
            return {
                /**
                 * the name of the icon in the form
                 * markerIconSet:markerIconName for 
                 * example "my-map-icons:hospital"
                 */
                iconName: {
                    type: String
                },
                /**
                 * icon height in px
                 * if not given, or 0, the viewbox of
                 * the icon definition is used
                 */
                iconHeight: {
                    type: Number,
                    value: 0
                },
                /**
                 * icon width in px
                 * if not given, or 0, the viewbox of
                 * the icon definition is used
                 */
                iconWidth: {
                    type: Number,
                    value: 0
                },
                /**
                 * an object who's data will be 
                 * substituted into the icon.
                 * Default is no data.
                 */
                iconData: {
                    type: Object,
                    value: () => {
                        return {};
                    }
                },
                /**
                 * the resolved google.maps.Icon 
                 */
                _plasticIcon: {
                    type: Object
                }
            }
        }

        static get observers() {
            return [
                '_iconAssignkmentTime(map, iconName, iconWidth, iconHeight, iconData)',
                // observers from google-map-marker 
                '_updatePosition(latitude, longitude)'
            ]
        }

        /**
         * Returns the resolved icon
         * @param {String} iconName - in the form set:name eg "my-markers:bakery"
         * @param {Number} iconWidth
         * @param {Number} iconHeight
         * @param {Object} iconData
         * @return {Object} google.maps.Icon  
         */
        _getPlasticMarkerIcon(iconName, iconWidth, iconHeight, iconData) {
            return new Promise((resolve, reject) => {
                let result; // undefined
                if (iconName) {
                    let iconNameParts = iconName.split(":");
                    if (iconNameParts.length == 2 && iconNameParts[0] && iconNameParts[1]) {
                        this._getMarkerSet(iconNameParts[0])
                            .then((mis) => {
                                let markerIconSet = mis;
                                if (markerIconSet) {
                                    result = markerIconSet.getMarkerIcon(iconNameParts[1],
                                        iconWidth,
                                        iconHeight, iconData);
                                    if (!result) {
                                        console.warn("icon definition not found: " + iconNameParts[
                                            1]);
                                    }
                                } else {
                                    console.warn("map marker icon set is not registered: " +
                                        iconNameParts[0]);
                                }
                                resolve(result);
                            });
                    } else {
                        console.warn("map marker icon names must be in form set:name");
                        resolve(result);
                    }
                } else {
                    resolve(result);
                }
            });
        }

        /**
         * observer for properties used to set the marker icon
         * 
         * Sets the icon (in the base class - google-map-marker)
         * @param {Object} map - google.maps.map from the base class
         * @param {String} iconName
         * @param {Number} iconWidth
         * @param {Number} iconHeight
         * @param {Object} iconData
         */
        _iconAssignkmentTime(map, iconName, iconWidth, iconHeight, iconData) {
            // can only assign if the map has loaded
            if (map) {
                if (iconName) {
                    this._getPlasticMarkerIcon(iconName, iconWidth, iconHeight, iconData)
                        .then((i) => {
                            this.icon = i;
                        });
                } else {
                    this.icon = null;
                }
            }
        }

        _getMarkerSet(setName) {
            return new Promise((resolve, reject) => {
                let meta = Polymer.Base.create('iron-meta', {
                    type: 'plasticMapMarkerSet'
                });
                if (meta && typeof meta.byKey === "function" && meta.byKey(setName)) {
                    resolve(meta.byKey(setName));
                } else {
                    document.addEventListener("plastic-map-marker-set-added", (e) => {
                        if (e.detail.set == setName) {
                            meta = Polymer.Base.create('iron-meta', {
                                type: 'plasticMapMarkerSet'
                            });
                            let markerIconSet = meta.byKey(setName);
                            if (markerIconSet) {
                                resolve(markerIconSet);
                            } else {
                                resolve(null);
                            }
                        }
                    });
                }
            });
        }

    }
    window.customElements.define(PlasticMapMarkerSvg.is, PlasticMapMarkerSvg);
</script>